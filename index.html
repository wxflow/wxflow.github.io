<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIP èµ„æºåŠ è½½ Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#4080FF',
                        accent: '#86B4FF',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .animate-pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .animate-spin-slow {
                animation: spin 2s linear infinite;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .animate-progress {
                animation: progress 2s linear infinite;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes progress {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen font-inter flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="bg-primary/5 p-6 border-b border-gray-100">
            <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-gray-800 text-center text-shadow">
                ZIP èµ„æºåŠ è½½
            </h1>
        </div>
        
        <div class="p-6 md:p-8">
            <!-- å›´ç»•æ–‡æœ¬æ¡†çš„è¿›åº¦æ¡åŠ¨ç”» -->
            <div class="relative mb-6">
                <div class="absolute inset-0 bg-gradient-to-r from-primary via-secondary to-primary bg-[length:200%_100%] animate-progress rounded-md blur-sm opacity-70"></div>
                <div id="console-output" class="relative bg-white p-4 rounded-md overflow-y-auto max-h-64 border border-gray-200 scrollbar-hide">
                    <!-- ç”¨äºæ˜¾ç¤º console è¾“å‡º -->
                </div>
            </div>
        </div>
        
        <div class="bg-gray-50 p-4 border-t border-gray-100">
            <div class="flex flex-wrap justify-center items-center text-sm text-gray-500 gap-2">
                <a href="https://github.com/valetzx/flow-wx" class="hover:underline flex items-center">
                    <span class="mr-1">ğŸ”—</span> æŸ¥çœ‹é¡¹ç›®æºç 
                </a>
                <span class="text-gray-300">|</span>
                <a href="#" class="hover:underline flex items-center">
                    <span class="mr-1">ğŸ“§</span> è”ç³»æˆ‘ä»¬
                </a>
            </div>
        </div>
    </div>

    <script>
        // é‡å†™ console.log æ–¹æ³•ï¼Œå°†è¾“å‡ºæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œæ·»åŠ éšæœºå»¶è¿Ÿ
        const originalConsoleLog = console.log;
        const consoleOutput = document.getElementById('console-output');
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            
            // ç”Ÿæˆ0.2~0.8ç§’çš„éšæœºå»¶è¿Ÿ
            const randomDelay = 200 + Math.random() * 600;
            
            setTimeout(() => {
                const logEntry = document.createElement('p');
                logEntry.textContent = args.join(' ');
                logEntry.className = 'my-1';
                
                // æ·»åŠ åˆ°æ§åˆ¶å°
                consoleOutput.appendChild(logEntry);
                
                // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
                consoleOutput.scrollTo({
                    top: consoleOutput.scrollHeight,
                    behavior: 'smooth'
                });
            }, randomDelay);
        };

        // æ·»åŠ åˆå§‹æç¤º
        console.log('æ­£åœ¨åˆå§‹åŒ–ç¯å¢ƒ...');
        console.log('å°è¯•æ³¨å†Œ Service Worker...');

        const zipUrls = [
            'https://m.wbiao.cn/mallapi/wechat/picReverseUrl?url=https://db0kqspitke0bs.database.nocode.cn/storage/v1/object/public/flow/flow.zip',
            'https://share-download.onmicrosoft.cn/2025-07-06/flowx-1751766989102.zip',
            'https://cnb.cool/valetzx/static/-/git/raw/main/flowx_flow.zip'
        ];

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(async reg => {
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸ');

                    // å¦‚æœå·²ç»æœ‰æ§åˆ¶å™¨ï¼Œç«‹å³ä¸‹è½½ ZIP
                    if (navigator.serviceWorker.controller) {
                        await fetchAndCacheZip();
                    } else {
                        // ç­‰å¾… Service Worker æ¿€æ´»åå†ä¸‹è½½
                        navigator.serviceWorker.addEventListener('controllerchange', async () => {
                            console.log('Service Worker å·²æ¿€æ´»');
                            await fetchAndCacheZip();
                        });
                    }
                })
                .catch(err => {
                    console.error('Service Worker æ³¨å†Œå¤±è´¥:', err);
                    // é”™è¯¯æç¤ºæ·»åŠ åˆ°é¡µé¢
                    addErrorLog('Service Worker æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯');
                });
        } else {
            console.error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
            // é”™è¯¯æç¤ºæ·»åŠ åˆ°é¡µé¢
            addErrorLog('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ Service Workerï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ');
        }

        async function fetchAndCacheZip() {
            console.log('å¼€å§‹è‡ªåŠ¨ä¸‹è½½ ZIP æ–‡ä»¶...');
            try {
                const arrayBuffer = await tryFetchZip(zipUrls);
                navigator.serviceWorker.controller.postMessage({
                    type: 'ZIP_CACHE',
                    arrayBuffer: arrayBuffer
                });
                console.log('ZIP æ•°æ®å·²å‘é€åˆ° Service Workerï¼Œæ­£åœ¨è§£å‹...');
            } catch (err) {
                console.error('ä¸‹è½½ ZIP èµ„æºåœ°å€å¤±è´¥:', err);
                // é”™è¯¯æç¤ºæ·»åŠ åˆ°é¡µé¢
                addErrorLog('ä¸‹è½½ ZIP èµ„æºåœ°å€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯');
            }
        }

        async function tryFetchZip(urlList) {
            for (let i = 0; i < urlList.length; i++) {
                try {
                    console.log(`å°è¯•é“¾æ¥: ${urlList[i]}`);
                    // æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
                    addStatusLog(`å°è¯•é“¾æ¥: ${i+1}/${urlList.length}`);
                    
                    const response = await fetch(urlList[i]);
                    if (!response.ok) throw new Error('å“åº”å¤±è´¥: ' + response.status);
                    
                    return await response.arrayBuffer();
                } catch (err) {
                    console.warn(`é“¾æ¥å¤±è´¥: ${urlList[i]}`, err);
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    addWarningLog(`é“¾æ¥å¤±è´¥: ${urlList[i]}`);
                    
                    if (i === urlList.length - 1) {
                        throw new Error('æ‰€æœ‰é“¾æ¥åœ°å€å¤±è´¥');
                    }
                }
            }
        }

        // ç›‘å¬ Service Worker æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.status) {
                console.log(event.data.status);
                
                // æ˜¾ç¤ºçŠ¶æ€æ›´æ–°
                addStatusLog(event.data.status);
                
                if (event.data.status === 'ZIP è§£å‹å®Œæˆï¼Œå‡†å¤‡å°±ç»ª') {
                    console.log('åŠ è½½å®Œæˆï¼Œè‡ªåŠ¨åˆ·æ–°é¡µé¢');
                    // æ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                    addSuccessLog('âœ… åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆ·æ–°é¡µé¢...');
                    
                    setTimeout(() => {
                        location.reload(); // è‡ªåŠ¨åˆ·æ–°é¡µé¢
                    }, 1500); // å»¶é•¿åˆ·æ–°æ—¶é—´ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°å®Œæˆä¿¡æ¯
                }
            }
        });

        // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ ä¸åŒç±»å‹çš„æ—¥å¿—
        function addStatusLog(message) {
            setTimeout(() => {
                const statusElement = document.createElement('p');
                statusElement.className = 'my-1';
                statusElement.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-gray-300 border-t-primary rounded-full animate-spin mr-2"></span>${message}`;
                consoleOutput.appendChild(statusElement);
                consoleOutput.scrollTo({ top: consoleOutput.scrollHeight, behavior: 'smooth' });
            }, 200 + Math.random() * 600);
        }

        function addWarningLog(message) {
            setTimeout(() => {
                const errorElement = document.createElement('p');
                errorElement.className = 'text-yellow-500 my-1';
                errorElement.innerHTML = `<span class="inline-block mr-2">âš ï¸</span>${message}`;
                consoleOutput.appendChild(errorElement);
                consoleOutput.scrollTo({ top: consoleOutput.scrollHeight, behavior: 'smooth' });
            }, 200 + Math.random() * 600);
        }

        function addErrorLog(message) {
            setTimeout(() => {
                const statusElement = document.createElement('p');
                statusElement.className = 'text-red-500 my-1';
                statusElement.textContent = message;
                consoleOutput.appendChild(statusElement);
                consoleOutput.scrollTo({ top: consoleOutput.scrollHeight, behavior: 'smooth' });
            }, 200 + Math.random() * 600);
        }

        function addSuccessLog(message) {
            setTimeout(() => {
                const successElement = document.createElement('p');
                successElement.className = 'text-green-500 font-bold my-2';
                successElement.textContent = message;
                consoleOutput.appendChild(successElement);
                consoleOutput.scrollTo({ top: consoleOutput.scrollHeight, behavior: 'smooth' });
            }, 200 + Math.random() * 600);
        }
    </script>
</body>
</html>
