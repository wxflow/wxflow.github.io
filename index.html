<body>
  <h1>ZIP 多源缓存 Demo</h1>
  <p id="status">正在初始化...</p>

  <script>
    const zipUrls = [
      'https://m.wbiao.cn/mallapi/wechat/picReverseUrl?url=https://db0kqspitke0bs.database.nocode.cn/storage/v1/object/public/flow/flowx/flow.zip',
      'https://share-download.onmicrosoft.cn/2025-07-06/flowx-1751766989102.zip',
      'https://cnb.cool/valetzx/static/-/git/raw/main/flowx_flow.zip'
    ];

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(async reg => {
          console.log('Service Worker 注册成功');

          // 如果已激活，立即尝试下载 ZIP
          if (navigator.serviceWorker.controller) {
            await fetchAndCacheZip();
          } else {
            // 等待 Service Worker 激活后再尝试下载
            navigator.serviceWorker.addEventListener('controllerchange', async () => {
              console.log('Service Worker 已接管');
              await fetchAndCacheZip();
            });
          }
        })
        .catch(err => {
          console.error('Service Worker 注册失败:', err);
          document.getElementById('status').textContent = 'Service Worker 注册失败';
        });
    } else {
      document.getElementById('status').textContent = '当前浏览器不支持 Service Worker';
    }

    async function fetchAndCacheZip() {
      document.getElementById('status').textContent = '正在自动下载 ZIP 文件...';
      try {
        const arrayBuffer = await tryFetchZip(zipUrls);
        navigator.serviceWorker.controller.postMessage({
          type: 'ZIP_CACHE',
          arrayBuffer: arrayBuffer
        });
        document.getElementById('status').textContent = 'ZIP 数据已发送到 Service Worker，正在缓存...';
      } catch (err) {
        console.error('所有 ZIP 下载地址都失败了:', err);
        document.getElementById('status').textContent = '所有 ZIP 下载地址都失败了';
      }
    }

    async function tryFetchZip(urlList) {
      for (let i = 0; i < urlList.length; i++) {
        try {
          console.log(`尝试下载: ${urlList[i]}`);
          const response = await fetch(urlList[i]);
          if (!response.ok) throw new Error('响应失败: ' + response.status);
          return await response.arrayBuffer();
        } catch (err) {
          console.warn(`下载失败: ${urlList[i]}`, err);
          if (i === urlList.length - 1) {
            throw new Error('所有下载地址都失败了');
          }
        }
      }
    }

    // 监听 Service Worker 消息
    navigator.serviceWorker.addEventListener('message', event => {
      if (event.data && event.data.status) {
        document.getElementById('status').textContent = event.data.status;

        if (event.data.status === 'ZIP 解压并缓存完成') {
          console.log('缓存完成，自动刷新页面');
          setTimeout(() => {
            location.reload(); // 自动刷新页面
          }, 500); // 可加一点延迟
        }
      }
    });
  </script>
</body>
